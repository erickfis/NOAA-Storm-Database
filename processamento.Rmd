Data Processing 

This code loads the original data and them choose which variables are useful to answer our questions:


```{r sample, echo=FALSE}
# linhas <- nrow(dados)
# linhas <- sample(linhas,50000)
# dataS <- dados[linhas,]
# write.csv(dataS, "StormData")
```


```{r libraries}

library(scales)
library(data.table)
library(chron)
library(dplyr)
library(lubridate)
library(ggplot2)
library(rmarkdown)
library(RColorBrewer)
library(gridExtra)
library(grid)

```


```{r load-e-tratamento, cache=TRUE}
#fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

#download.file(fileUrl, "StormData.bz2", method = "curl")

#Full data
#dados <- fread(sprintf("bzcat %s | tr -d '\\000'", "StormData.bz2"), na.strings = "")
dados <- fread(sprintf("bzcat %s | tr -d '\\000'", "StormData.bz2"))
dados <-tbl_df(dados)

# treating var names
names(dados) <- gsub("_", ".", tolower(names(dados)))
names(dados)   
```

```{r}
dados <- select(dados, -1)
```
This database has `r nrow(dados)` observations. Each observation corresponds to an event occurrence.

To determine the most harmful events to human health, we will check the variables related to human health, which are "fatalities" and "injuries".

To determine the most harmful events to economy, we will check the variables related to economic measures, from "propdmg" through "cropdmgexp". 

Also, in order to analyse various occurrences of the same event, we will measure the duration of the event, its magnitude and where the event occurred (state and county name).




```{r select-duration, cache=TRUE}
# select desired vars
harm.df <- dados %>% select(evtype, mag, state, countyname, bgn.date, end.date, 23:28)

# treat vars
harm.df <- harm.df %>% 
        mutate(bgn.date = mdy_hms(bgn.date), end.date = mdy_hms(end.date),  
               day = as.Date(bgn.date, "%m/%d/%Y"), 
               duration = -as.period(interval(end.date, bgn.date)),
               event = tolower(as.character(evtype)),
               countyname =strtrim(countyname,9)) %>%
        select(event, 2, day, duration, 3:4, 7:12)

# fixing exp for economic data
harm.df$propdmgexp[which(harm.df$propdmgexp=="K")] <- as.character(3)
harm.df$propdmgexp[which(harm.df$propdmgexp=="m")] <- as.character(6)
harm.df$propdmgexp[which(harm.df$propdmgexp=="M")] <- as.character(6)
harm.df$propdmgexp[which(harm.df$propdmgexp=="B")] <- as.character(9)
harm.df$propdmgexp <- as.numeric(harm.df$propdmgexp)

harm.df$cropdmgexp[which(harm.df$cropdmgexp=="K")] <- as.character(3)
harm.df$cropdmgexp[which(harm.df$cropdmgexp=="m")] <- as.character(6)
harm.df$cropdmgexp[which(harm.df$cropdmgexp=="M")] <- as.character(6)
harm.df$cropdmgexp[which(harm.df$cropdmgexp=="B")] <- as.character(9)
harm.df$cropdmgexp <- as.numeric(harm.df$cropdmgexp)

harm.df <- mutate(harm.df, prop.ev = propdmg*10^propdmgexp,
                crop.ev = cropdmg*10^cropdmgexp)

# treating event types

eventos <- harm.df$event
# first, need to see what are the event types
contagem <- sort(table(eventos))

# them we create this list of terms
 
lista <- c(
"wind",
"snow",
"flood",
"cold|freez",
"hurricane",
"tornado",
"rain|precip",
"hail",
"heat|warm",
"tide",
"storm",
"record",
"blizzard",
"fire",
"funnel",
"surf")

for (i in 1:length(lista)) {
        eventos[grepl(lista[i], eventos)] <- lista[i]
        
}

# lets group the events whose count is < 5 and call it "other"
contagem <- sort(table(eventos))
outros <- names(contagem[contagem<5])
eventos[eventos %in% outros] <- "other"
# sort(table(eventos))

# returning treated events
harm.df$event <- toupper(eventos)

rm(dados) # house cleanning
```
