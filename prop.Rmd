### Most Property Damaging event in a single occurrence
Most Property Damaging event in a single occurrence

In order to determine what were the most property damaging events in a single occurrence, we need to see how damages are distributed along the occurrences.



```{r prop-distr-1, cache=TRUE}
# property damages
rm(injuring.df, injuring.all.df, injuring95.df) # cleannig house

prop.df <- harm.df %>% filter(!is.na(prop.ev)) %>%
                        select(1:6,13)
                

# quantiles
qt <- quantile(prop.df$prop.ev, probs=seq(.975,1,0.002))

# display only the qts next to harmfull events
qt

# distribution plot
plt.distr.prop0 <- ggplot(prop.df, aes(log(prop.ev)))

plt.distr.prop0 <- plt.distr.prop0 + geom_density(aes(y=..density..)) + #xlim(0,.5) + 
        labs(title="All events", x="log(amount $)") +
        theme(plot.title = element_text(hjust = 0.5))       

```

Looking at this distribution, we can infer that 95% of the occurrences caused less than **`r dollar(qt[1])` in losses**.

On the other hand, damaging occurrences had to have damages above zero.

Now, among the damaging occurrences, we are interested in the ones whose damages are beyond the confidence interval, ie. above 95% of the most common values. 

```{r prop-distr-2, cache=TRUE}

# subset for harm events
prop.df <- prop.df %>% filter(prop.ev > 0) %>%
                arrange(desc(prop.ev)) %>%
                mutate(value = dollar(prop.ev),
                        media.raw = mean(prop.ev), 
                        mediana.raw = median(prop.ev),
                        mean = dollar(media.raw),
                        median = dollar(mediana.raw),
                        rank = seq_len(length(event)))
# quantiles, same as 

qt <- quantile(prop.df$prop.ev, probs=seq(.999,1,0.002))
qt

# distribution plot
plt.distr.prop1 <- ggplot(prop.df, aes(log(prop.ev)))

plt.distr.prop1 <- plt.distr.prop1 + geom_density(aes(y=..density..)) + #xlim(0,100) + 
        labs(title="Damaging events", x="log(amount $)") +
        theme(plot.title = element_text(hjust = 0.5))     

grid.arrange(plt.distr.prop0, plt.distr.prop1, nrow=1, ncol=2, 
             bottom="Figure - Distribution of Losses: all events VS damaging events")
grid.rect(gp=gpar(fill=NA)) 
```

Looking at this distribution, we can infer that **95% of the damaging occurrences caused up to `r dollar(qt[1])` in losses**.

In this study, we looked on the 0,1% most harmful occurrences. 

```{r prop-single-95, cache=TRUE}

# subset for 95% CI
prop95.df <- filter(prop.df, prop.ev>qt[1])

# create color pallete for all events
colourCount = length(unique(prop95.df$event))
getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))


# print a table
kable(prop95.df[,c(13,1:6,8,11:12)])

# prepare text for inline R
worst.prop.single.ev <- prop95.df$event[1]
worst.prop.single.st <- prop95.df$state[1]
worst.prop.single.ct <- prop95.df$countyname[1]
worst.prop.single.dt <- prop95.df$day[1]
worst.prop.single.value <- prop95.df$value[1]

```



```{r prop-single-plot, cache=TRUE}

plt.prop.single <- ggplot(prop95.df, aes(day, prop.ev, colour=event))

(plt.prop.single <- plt.prop.single + geom_point() +
        geom_text(aes(label=ifelse(rank <= 10,
                as.character(day),""),
                hjust=-.03,vjust=0.5)) +
        geom_hline(aes(yintercept = media.raw), linetype=2) +
         geom_hline(aes(yintercept = mediana.raw), linetype=3) +
        labs(title="Most Property Dammaging Events in a Single Occurrence",
                    y="Damages", x="") + 
                
        expand_limits(x=as.Date('2017-01-01'))+ #ok
        scale_y_continuous(labels = dollar)+
        
        scale_colour_manual(values = getPalette(colourCount))+                
        theme(legend.title=element_blank()) +
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5)) 
)  

  
```



The single most economic damaging  event to properties was a **`r worst.prop.single.ev`, that occurred in `r worst.prop.single.st`, `r worst.prop.single.ct`, on `r worst.prop.single.dt`, causing U$ `r worst.prop.single.value` in losses**.



### Most Property Damaging event in all time
Most Property Damaging event in all time


Notice that are several occurrences of the same type of event along the time. 

Therefore, in order to know which is the worst type of event along all the years, we summed up the losses caused by each one of occurrences of this events. 

Notice that we are interested only in the worst of them, ie, the ones which are above the mean.


```{r prop-all, cache=TRUE}

# totals per event
prop.all.df <- prop.df %>% group_by(event) %>%
                summarise(total.raw = sum(prop.ev)) %>%
                arrange(desc(total.raw)) %>%
                mutate(media.raw = mean(total.raw), 
                        mediana.raw = median(total.raw),
                        total = dollar(total.raw),
                        mean = dollar(media.raw),
                        median = dollar(mediana.raw),
                        rank = seq_len(length(event))) %>%
                filter(total.raw > mean(total.raw))
                
# create color pallete for all events
colourCount = length(unique(prop.all.df$event))
getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))

# prepare text for inline R
worst.prop.all.ev <- prop.all.df$event[1]
worst.prop.total <- prop.all.df$total[1]

# a table
kable(prop.all.df[, c(8,1,5:7)])


```



```{r prop-all-plot, cache=TRUE}

plt.prop.all <- ggplot(data=prop.all.df, aes(event, total.raw, fill=event))

(plt.prop.all <- plt.prop.all + geom_bar(stat="identity") +
                
        geom_text(aes(label=ifelse(total.raw==max(total.raw),
                paste(event, dollar(max(total.raw)), sep=": "),'')),
                hjust=0,vjust=2) +
        geom_hline(aes(yintercept = media.raw), linetype=1) +
        geom_hline(aes(yintercept = mediana.raw), linetype=2) +
        labs(title="Most property damaging event", y="Damages", x="") + 
                
        scale_y_continuous(labels = dollar)+
     
        theme(legend.position="none") +        
        scale_colour_manual(values = getPalette(colourCount))+                
        theme(legend.title=element_blank()) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5))                 
  
)  

```



The most property damaging event along the time is the **`r worst.prop.all.ev`. It has caused `r worst.prop.total` in losses. **


Just for curiosity, these are the less damaging events:

```{r prop-less, cache=TRUE}

prop.all.df <- prop.df %>% group_by(event) %>%
                summarise(total.raw = sum(prop.ev)) %>%
                arrange(total.raw) %>%
                mutate(media.raw = mean(total.raw), 
                        mediana.raw = median(total.raw),
                        total = dollar(total.raw),
                        mean = dollar(media.raw),
                        median = dollar(mediana.raw),
                        rank = seq(length(event),1, by=-1))



kable(prop.all.df[1:10, c(8,1,5:7)])


```

