### Most fatal in a single occurrence

Most fatal in a single occurrence


In order to determine what were the most fatal events in a single occurrence, we need to see how fatalities are distributed along the occurrences.


```{r fatal-distr, cache=TRUE}
# subset original data
fatal.df <- harm.df %>% 
                filter(!is.na(fatalities)) %>%
                select(1:7)


# quantiles
qt <- quantile(fatal.df$fatalities, probs=seq(.9,1,0.001))

# display only the qts next to fatal events
qt[(length(qt)-(length(qt[qt>=1])+1)): length(qt)]
```

    
         

Looking at this distribution, we can infer that the vast majority of those occurrences were not fatal at all: **`r names(qt[qt==0])[length(qt[qt==0])]` occurrences didn't caused any fatalities.**

On the other hand, fatal occurrences had to have at least 1 fatality.

Now, among the fatal occurrences, we are interested in the ones whose fatalities are beyond the confidence interval, ie. above 95% of the most common values. 



```{r fatal-distr2, cache=TRUE}

# subset for fatal events
fatal.df <- filter(fatal.df, fatalities > 0) %>%
                arrange(desc(fatalities)) %>%
                mutate(mean = mean(fatalities), 
                median = median(fatalities),
                rank = seq_len(length(event)))


# quantiles, same as 
# poisson.test(mean, conf.level = 0.95)

qt <- quantile(fatal.df$fatalities, probs=seq(.975,1,0.005))
qt
```

Distribution plots

```{r fatal-distr3, cache=TRUE}


# distribution plot
plt.distr.fatal0 <- ggplot(fatal.df, aes(fatalities))

plt.distr.fatal0 <- plt.distr.fatal0 + geom_density(aes(y=..density..)) + xlim(0,.5) + 
        labs(title="All events") +
        theme(plot.title = element_text(hjust = 0.5))   

plt.distr.fatal1 <- ggplot(fatal.df, aes(fatalities))

plt.distr.fatal1 <- plt.distr.fatal1 + geom_density(aes(y=..density..)) + xlim(0,qt[1]) + 
        labs(title="Fatal events") +
        theme(plot.title = element_text(hjust = 0.5))


grid.arrange(plt.distr.fatal0, plt.distr.fatal1, nrow=1, ncol=2, 
             bottom="Figure 1 - Distribution of fatalities: all events VS fatal events")
grid.rect(gp=gpar(fill=NA))



```

Looking at this distribution, we can infer that **95% of the fatal occurrences caused up to `r qt[1]` fattalities**.

In this study, we looked on the 5% deadliest occurrences. 



```{r fatal, cache=TRUE}
# subset for 95% CI
fatal95.df <- fatal.df %>% filter(fatalities>qt[1])
                
# create color pallete for all events
colourCount = length(unique(fatal95.df$event))
getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))

# print a table
kable(fatal95.df[, c(10,1:9)])

# prepare text for inline R
worst.fatal.single.ev <- fatal95.df$event[1]
worst.fatal.single.st <- fatal95.df$state[1]
worst.fatal.single.ct <- fatal95.df$countyname[1]
worst.fatal.single.dt <- fatal95.df$day[1]
worst.fatal.single.kill <- fatal95.df$fatalities[1]


```



```{r fatal-plot-single, cache=TRUE}
# the plot
plt.fatal.single <- ggplot(fatal95.df, aes(day, fatalities, colour=event))

(plt.fatal.single <- plt.fatal.single + geom_point() +
        geom_text(aes(label=ifelse(rank <= 10, 
                as.character(day),""),
                hjust=-.03,vjust=0.5)) +                
        geom_hline(aes(yintercept = mean), linetype=2) +
        geom_hline(aes(yintercept = median), linetype=3) +
        labs(title="Most Fatal Events in a Single Occurrence",
                    y="Fatalities", x="Ocurrence Date") +
    
        expand_limits(x=as.Date('2017-01-01'))+ #ok
        scale_colour_manual(values = getPalette(colourCount))+                
        theme(legend.title=element_blank()) +
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5))                 
)  


```


The single most fatal event was a **`r worst.fatal.single.ev`, that occurred in `r worst.fatal.single.st`, `r worst.fatal.single.ct`, on `r worst.fatal.single.dt`, killing `r worst.fatal.single.kill` people.**

However, if we compare this single awful event to the mean of fatalities caused, we see that this is very unlikely to happen.



### Most fatal in all time
Most fatal in all time

Notice that are several occurrences of the same type of event along the time. 

Therefore, in order to know which is the worst type of event along all the years, we summed up the fatalities caused by each one of occurrences of this events. 

Notice that we are interested only in the worst of them, ie, the ones which are above the mean.




```{r fatal-all, cache=TRUE}

# totals per event
fatal.all.df <- fatal.df %>% group_by(event) %>%
        summarise(total = sum(fatalities)) %>% arrange(desc(total)) %>% 
        mutate(mean = mean(total), median = median(total),
               rank = seq_len(length(event))) %>%
        filter(total > mean(total))

# create color pallete for all events
colourCount = length(unique(fatal.all.df$event))
getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))

# prepare text for inline R
worst.fatal.all.ev <- fatal.all.df$event[1]
worst.fatal.all.kill <- fatal.all.df$total[1]

# a table
kable(fatal.all.df[,c(5,1:4)])


```




```{r fatal-plot-alltime, cache=TRUE}

# the plot
plt.fatal.all <- ggplot(data=fatal.all.df, aes(event, total, fill=event))

(plt.fatal.all <- plt.fatal.all + geom_bar(stat="identity") +
     
        geom_text(aes(label=ifelse(total==max(total),
                paste(event, max(total), sep=": "),'')),
                hjust=0,vjust=2) +
        geom_hline(aes(yintercept = mean), linetype=1) +
        geom_hline(aes(yintercept = median), linetype=2) +
        labs(title="Most Fatal events - all time", y="Fatalities",
             x="") + 
                
        theme(legend.position="none") +        
        scale_colour_manual(values = getPalette(colourCount))+                
        theme(legend.title=element_blank()) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5))                 
                
                
)  

```


The most fatal event along the time is the **`r worst.fatal.all.ev`. It has killed `r worst.fatal.all.kill` people until now.**


Just for curiosity, these are the less fatal among the fatal events:

```{r fatal-less, cache=TRUE}
# sort for less dangerous, had to subset again due to previous filtering
fatal.all.df <- fatal.df %>% group_by(event) %>%
        summarise(total = sum(fatalities)) %>% arrange(total) %>% 
        mutate(mean = mean(total), median = median(total),
               rank = seq(length(event),1, by=-1))

# a table
kable(fatal.all.df[1:10,c(5,1:2)])


```

