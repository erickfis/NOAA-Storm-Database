### Most Crop Damaging event in a single occurrence
Most Crop Damaging event in a single occurrence

In order to determine what were the most crop damaging events in a single occurrence, we need to see how damages are distributed along the occurrences.


```{r crop-distr-1, cache=TRUE}
# crop damages
rm(prop.df, prop.all.df, prop95.df) # cleannig house

crop.df <- harm.df %>% filter(!is.na(crop.ev)) %>%
                select(1:6,14) 


# quantiles
qt <- quantile(crop.df$crop.ev, probs=seq(.975,1,0.002))

# display only the qts next to harmfull events
qt

 
```

Looking at this distribution, we can infer that 95% of the occurrences caused less than **`r dollar(qt[1])` in losses**.

On the other hand, damaging occurrences had to have damages above zero.

Now, among the damaging occurrences, we are interested in the ones whose damages are beyond the confidence interval, ie. above 95% of the most common values. 



```{r crop-distr-2, cache=TRUE}

# subset for harm events
crop.df <- crop.df %>% filter(crop.ev > 0) %>%
                arrange(desc(crop.ev)) %>%
                mutate(value = dollar(crop.ev),
                        media.raw = mean(crop.ev), 
                        mediana.raw = median(crop.ev),
                        mean = dollar(media.raw),
                        median = dollar(mediana.raw),
                        rank = seq_len(length(event)))

# quantiles, same as 
# poisson.test(mean, conf.level = 0.95)

qt <- quantile(crop.df$crop.ev, probs=seq(.975,1,0.005))
qt
```

Distribution plots


```{r crop-distr-3, cache=TRUE}

# distribution plot
plt.distr.crop0 <- ggplot(crop.df, aes(log(crop.ev)))

plt.distr.crop0 <- plt.distr.crop0 + geom_density(aes(y=..density..)) + #xlim(0,.5) + 
        labs(title="All events", x="log(amount $)") +
        theme(plot.title = element_text(hjust = 0.5))  


# distribution plot
plt.distr.crop1 <- ggplot(crop.df, aes(log(crop.ev)))

plt.distr.crop1 <- plt.distr.crop1 + geom_density(aes(y=..density..)) + #xlim(0,qt[1]) + 
        labs(title="Damaging events", x="log(amount $)") +
        # scale_x_continuous(labels = dollar)+
        # theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5))       

grid.arrange(plt.distr.crop0, plt.distr.crop1, nrow=1, ncol=2, 
             bottom="Figure - Distribution of Losses: all events VS damaging events")
grid.rect(gp=gpar(fill=NA))  
```


Looking at this distribution, we can infer that **95% of the damaging occurrences caused up to `r dollar(qt[1])` in losses.**

In this study, we looked on the 5% most harmful occurrences. 

```{r crop-single-95, cache=TRUE}

# subset for 95% CI
crop95.df <- filter(crop.df, crop.ev>qt[1])

# create color pallete for all events
colourCount = length(unique(crop95.df$event))
getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))


# print a table
kable(crop95.df[,c(13,1:6,8,11:12)])

worst.crop.single.ev <- crop95.df$event[1]
worst.crop.single.st <- crop95.df$state[1]
worst.crop.single.ct <- crop95.df$countyname[1]
worst.crop.single.dt <- crop95.df$day[1]
worst.crop.single.value <- crop95.df$value[1]


```



```{r crop-single-plot, cache=TRUE}

plt.crop.single <- ggplot(crop95.df, aes(day, crop.ev, colour=event))

(plt.crop.single <- plt.crop.single + geom_point() +
        geom_text(aes(label=ifelse(rank <= 10,
                as.character(day),""),
                hjust=-.03,vjust=0.5)) +
        geom_hline(aes(yintercept = media.raw), linetype=2) +
        geom_hline(aes(yintercept = mediana.raw), linetype=3) +
        labs(title="Most Crop Dammaging Events in a Single Occurrence",
                    y="Damages", x="") + 
                
        expand_limits(x=as.Date('2017-01-01'))+ #ok
        scale_y_continuous(labels = dollar)+
        
        scale_colour_manual(values = getPalette(colourCount))+                
        theme(legend.title=element_blank()) +
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5)) 
)  

  
```

The single most economic damaging  event to crops was a **`r worst.crop.single.ev`, that occurred in `r worst.crop.single.st`, `r worst.crop.single.ct`, on `r worst.crop.single.dt`, causing U$ `r worst.crop.single.value` in losses.**


### Most Crop Damaging event in all time
Most Crop Damaging event in all time


Notice that are several occurrences of the same type of event along the time. 

Therefore, in order to know which is the worst type of event along all the years, we summed up the losses caused by each one of occurrences of this events. 

Notice that we are interested only in the worst of them, ie, the ones which are above the mean.


```{r crop-all, cache=TRUE}

# totals per event
crop.all.df <- crop.df %>% group_by(event) %>%
                summarise(total.raw = sum(crop.ev)) %>%
                arrange(desc(total.raw)) %>%
                mutate(media.raw = mean(total.raw), 
                        mediana.raw = median(total.raw),
                        total = dollar(total.raw),
                        mean = dollar(media.raw),
                        median = dollar(mediana.raw),
                        rank = seq_len(length(event))) %>%
                filter(total.raw > mean(total.raw))
                
# create color pallete for all events
colourCount = length(unique(crop.all.df$event))
getPalette = colorRampPalette(brewer.pal(colourCount, "Set1"))

# prepare text for inline R
worst.crop.all.ev <- crop.all.df$event[1]
worst.crop.total <- crop.all.df$total[1]

# a table
kable(crop.all.df[, c(8,1,5:7)])

```

```{r crop-all-plot, cache=TRUE}

plt.crop.all <- ggplot(data=crop.all.df, aes(event, total.raw, fill=event))

(plt.crop.all <- plt.crop.all + geom_bar(stat="identity") +
                
        geom_text(aes(label=ifelse(total.raw==max(total.raw),
                paste(event, dollar(max(total.raw)), sep=": "),'')),
                hjust=0,vjust=2) +
        geom_hline(aes(yintercept = media.raw), linetype=1) +
        geom_hline(aes(yintercept = mediana.raw), linetype=2) +
        labs(title="Most Crop damaging event", y="Damages", x="") + 
                
        scale_y_continuous(labels = dollar)+
     
        theme(legend.position="none") +        
        scale_colour_manual(values = getPalette(colourCount))+                
        theme(legend.title=element_blank()) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
        theme(plot.title = element_text(hjust = 0.5))                 
  
)  

```



The most crop damaging event along the time is the **`r worst.crop.all.ev`. It has caused `r worst.crop.total` in losses.**


Just for curiosity, lets show now what are the less damaging among the  events:


```{r crop-less, cache=TRUE}

crop.all.df <- crop.df %>% group_by(event) %>%
                summarise(total.raw = sum(crop.ev)) %>%
                arrange(total.raw) %>%
                mutate(media.raw = mean(total.raw), 
                        mediana.raw = median(total.raw),
                        total = dollar(total.raw),
                        mean = dollar(media.raw),
                        median = dollar(mediana.raw),
                        rank = seq(length(event),1, by=-1))



kable(crop.all.df[1:10, c(8,1,5:7)])


```
